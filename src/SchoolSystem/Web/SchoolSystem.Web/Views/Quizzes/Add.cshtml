@model QuizzesInputModel

<form method="post">
    <div asp-validation-summary="All" class="text-danger"></div>
    <div class="mb-3">
        <label asp-for="Name"></label>
        <input asp-for="Name" class="form-control" />
        <div>
            <span asp-validation-for="Name" class="text-danger"></span>
        </div>
    </div>

    <div class="mb-3">
        <label asp-for="SubjectId"></label>
        <select asp-for="SubjectId" class="form-select" asp-items="@(new SelectList(Model.ViewModel.Subjects, "Id", "Name"))">
            <option selected="selected" value="">Моля избери</option>
        </select>
        <div>
            <span asp-validation-for="SubjectId" class="text-danger"></span>
        </div>
    </div>

    <div class="mb-3">
        <label asp-for="ClassesId"></label>
        <select asp-for="ClassesId" class="form-select" asp-items="@(new SelectList(Model.ViewModel.Classes, "Id", "Name"))" data-bs-toggle="tooltip" data-bs-placement="top"
                data-bs-custom-class="custom-tooltip"
                data-bs-title="Може да изберете повече от един клас.">
            <option selected="selected" value="">Моля избери</option>
        </select>
        <div>
            <span asp-validation-for="ClassesId" class="text-danger"></span>
        </div>
    </div>

    <div class="mb-3">
        <label asp-for="QuizType"></label>
        <select asp-for="QuizType" class="form-select" asp-items="@Html.GetEnumSelectList<QuizType>()">
            <option selected="selected" value="">Моля избери</option>
        </select>
        <div>
            <span asp-validation-for="QuizType" class="text-danger"></span>
        </div>
    </div>

    <div class="mb-3">
        <label asp-for="DateTaken"></label>
        <input asp-for="DateTaken" type="text" autocomplete="off" class="form-control" placeholder="Натисни върху полето, за да избереш дата и час." />
        <div>
            <span asp-validation-for="DateTaken" class="text-danger"></span>
        </div>

        <div class="mb-3 duration">
            <label asp-for="Duration"></label>
            <input asp-for="Duration" class="form-control" min="10" max="180" />
            <div>
                <span asp-validation-for="Duration" class="text-danger"></span>
            </div>
        </div>
    </div>

    <button class="btn btn-primary display-question">Добавяне на въпрос</button>

    <div class="questions-buttons-container" style="margin-top: 10px;"></div>

    <div id="question-container-0" class="question-container" style="display: none;">
        <label asp-for="Questions[0].Title">Условие на въпроса</label>
        <input asp-for="Questions[0].Title" class="form-control" />

        <div>
            <span asp-validation-for="Questions[0].Title" class="text-danger"></span>
        </div>
        <label asp-for="Questions[0].QuestionType">Тип на въпроса</label>
        <select asp-for="Questions[0].QuestionType" asp-items="Html.GetEnumSelectList<QuestionType>()" class="form-select"></select>
        <div>
            <span asp-validation-for="Questions[0].QuestionType" class="text-danger"></span>
        </div>



        <div id="answers-container" class="mb-3">
            <table class="table">
                <tr>
                    <th></th>
                    <th>Отговор</th>
                    <th style="text-align: center;">
                        Маркирай като верен отговор
                        <div>
                            <span asp-validation-for="Questions[0].Answers.IsFirstAnswerCorrect" class="text-danger"></span>
                        </div>


                    </th>
                </tr>
                <tr>
                    <td><label for="option_a">А)</label></td>
                    <td class="option_a_container">
                        <input asp-for="Questions[0].Answers.FirstAnswerContent" class="form-control ms-2" />

                        <div>
                            <span asp-validation-for="Questions[0].Answers.FirstAnswerContent" class="text-danger"></span>
                        </div>
                    </td>

                    <td>
                        <div style="text-align:center;"><input type="checkbox" class="checkboxes" asp-for="Questions[0].Answers.IsFirstAnswerCorrect" /></div>
                    </td>
                </tr>
                <tr>
                    <td><label for="option_b">Б)</label></td>
                    <td class="option_b_container">
                        <input asp-for="Questions[0].Answers.SecondAnswerContent" class="form-control ms-2" />
                        <div>
                            <span asp-validation-for="Questions[0].Answers.SecondAnswerContent" class="text-danger"></span>
                        </div>
                    </td>
                    <td>
                        <div style="text-align:center;"><input type="checkbox" class="checkboxes" asp-for="Questions[0].Answers.IsSecondAnswerCorrect" /></div>
                    </td>
                </tr>
                <tr>
                    <td><label for="option_c">В)</label></td>
                    <td class="option_c_container">
                        <input asp-for="Questions[0].Answers.ThirdAnswerContent" class="form-control ms-2" />
                        <div>
                            <span asp-validation-for="Questions[0].Answers.ThirdAnswerContent" class="text-danger"></span>
                        </div>
                    </td>

                    <td>
                        <div style="text-align:center;"><input type="checkbox" class="checkboxes" asp-for="Questions[0].Answers.IsThirdAnswerCorrect" /></div>
                    </td>


                </tr>
                <tr>
                    <td><label for="option_d">Г)</label></td>
                    <td class="option_d_container">
                        <input asp-for="Questions[0].Answers.FourthAnswerContent" class="form-control ms-2" />
                        <div>
                            <span asp-validation-for="Questions[0].Answers.FourthAnswerContent" class="text-danger"></span>
                        </div>
                    </td>
                    <td>
                        <div style="text-align:center;"><input type="checkbox" class="checkboxes" asp-for="Questions[0].Answers.IsFourthAnswerCorrect" /></div>
                    </td>

                </tr>
            </table>
        </div>

        <button class="btn btn-primary save-question mt-2">Запазване на въпроса</button>
    </div>


    <div class="text-center">
        <button type="submit" class="btn add-test btn-primary mt-2">Добавяне на тест</button>
    </div>
</form>

@section Scripts {

    

    <script>
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

        $.datetimepicker.setLocale('bg');
        jQuery("input#DateTaken").datetimepicker();
    </script>

    <script>
        //for (let i = 0; i < localStorage.length; i++) {
        //    let curElement = localStorage.getItem(localStorage.key(i));
        //    if (localStorage.key(i).includes("Questions_html")) {
        //        let questionIndex = parseInt($(curElement).attr("id").split("-")[2]);
        //        $(curElement).insertAfter($(".question-container").eq(-1));

        //        itemsArr = [`Questions_${questionIndex}__Title`, `Questions_${questionIndex}__QuestionType`, `Questions_${questionIndex}__Answers_FirstAnswerContent`
        //            , `Questions_${questionIndex}__Answers_IsFirstAnswerCorrect`, `Questions_${questionIndex}__Answers_SecondAnswerContent`, `Questions_${questionIndex}__Answers_IsSecondAnswerCorrect`
        //            , `Questions_${questionIndex}__Answers_ThirdAnswerContent`, `Questions_${questionIndex}__Answers_IsThirdAnswerCorrect`, `Questions_${questionIndex}__Answers_FourthAnswerContent`
        //            , `Questions_${questionIndex}__Answers_IsFourthAnswerCorrect`];

        //        for (const item of itemsArr) {
        //            if (!item.endsWith("Correct")) {
        //                $(".question-container").eq(-1).find(`#${item}`).val(localStorage.getItem(item));
        //            }
        //            else {
        //                $(".question-container").eq(-1).find(`#${item}`).prop("checked", localStorage.getItem(item) == "true");
        //            }

        //            //localStorage.removeItem(item);


        //        }
        //        localStorage.removeItem(`Questions_html_${questionIndex}`);
        //        $(".questions-buttons-container").append(`<button id="question-button-${questionIndex}" class="question-button" style="margin-right: 10px;">${questionIndex + 1}</button>`);
        //    }

        //}



        if ($(".validation-summary-errors").length > 0) {

            $(".questions-buttons-container").append(`<button id="question-button-0" class="question-button" style="margin-right: 10px;">1</button>`);
        }

        //CLONE AND ATTACH CLIENT VALIDATION TO THE CLONED ELEMENTS.

        let isFirst = true

        $(".display-question").click(function (e) {
            e.preventDefault();
            $(".questions-buttons-container button").removeClass("bg-success");
            if (isFirst) {
                $(".question-container").eq(-1).fadeIn();
                isFirst = false;
            }
            else if ($(".question-container").eq(-1).hasClass("submitted")) {
                $(".question-container").hide();

                let cloning = $(".question-container").eq(-1).clone(true, true).removeClass("submitted").fadeIn();
                cloning.find(".save-question").text("Запазване на въпроса");
                let prevContainerIndex = parseInt($(".question-container").eq(-1).attr("id").split("-")[2]);

                cloning.attr("id", `question-container-${prevContainerIndex + 1}`)



                cloning.find("label").each(function () {
                    let labelForUpdated = $(this).attr("for").replace(`_${prevContainerIndex}__`, `_${prevContainerIndex + 1}__`);

                    $(this).attr("for", labelForUpdated);

                });

                cloning.find("input:text").each(function () {
                    let ariaDescribedByUpdated = $(this).attr("aria-describedby").replace(`_${prevContainerIndex}__`, `_${prevContainerIndex + 1}__`);
                    $(this).attr("aria-describedby", ariaDescribedByUpdated);

                });

                cloning.find("input:checkbox").each(function () {
                    let ariaDescribedByUpdated = $(this).attr("aria-describedby").replace(`[${prevContainerIndex}]`, `[${prevContainerIndex + 1}]`);
                    $(this).attr("aria-describedby", ariaDescribedByUpdated);

                });

                let updatedValMsg = cloning.find("table tr").eq(0).find("th").eq(2).find("span.text-danger").attr("data-valmsg-for").replace(`[${prevContainerIndex}]`, `[${prevContainerIndex + 1}]`);

                cloning.find("table tr").eq(0).find("th").eq(2).find("span.text-danger").attr("data-valmsg-for", updatedValMsg);

                cloning.find("input,select").each(function () {
                   if ($(this).is(":text")) {
                        $(this).val('');
                   }
                   else if ($(this).is(":checkbox")) {
                        $(this).prop("checked", false);
                   }
                   else {
                       $(this).val("0");
                   }
                    
                    $(this).attr("id", $(this).attr("id").replace(`_${prevContainerIndex}__`, `_${prevContainerIndex + 1}__`));
                    $(this).attr("name", $(this).attr("name").replace(`[${prevContainerIndex}]`, `[${prevContainerIndex + 1}]`));
                    if ($(this).is(':not(:checkbox)')) {
                        $(this).next().find("span").eq(0).attr("data-valmsg-for", $(this).next().find("span").eq(0).attr("data-valmsg-for").replace(`[${prevContainerIndex}]`, `[${prevContainerIndex + 1}]`));
                    }

                });

                cloning.insertAfter($(".question-container").eq(-1));

            }
            else if ($(".question-container").eq(-1).is(":hidden")) {
                $(".question-container").hide();
                $(".question-container").eq(-1).fadeIn();
            }


            //WITHOUT THIS, CLIENT VALIDATION DOES NOT WORK ON CLONINGS!!!
            $("form").removeData('validator').removeData('unobtrusiveValidation');
            $.validator.unobtrusive.parse($("form"));


        });

        // LIMIT TO ONE ALLOWED CHECK IF RADIO
        $("input:checkbox").change(function () {
            if ($(this).closest(".question-container").find("select").val() == '0') {
                if ($(this).is(":checked") && $(this).closest("#answers-container").find("input:checkbox:checked").length > 1) {
                    $(this).closest("#answers-container").find("input:checkbox:checked").not($(this)).prop("checked", false);
                }
            }
        });

    </script>

    <script>

        //TRIGGER VALIDATION ON EACH DISPLAYED CHECKBOX, IF ONE OF THE CHECKBOXES IS CHECKED THE RULE checkatleastone WILL RETURN TRUE FOR ALL OF THEM WHICH WILL HIDE THE ERROR MESSAGE


        $(".question-container").find("#answers-container").find("input:checkbox").change(function () {
            $(".question-container").find("#answers-container").find("input:checkbox").each(function () {

                console.log($(this));

                $("form").validate().element('#' + $(this).attr("id"));
            });
            
        });

        $(".question-container").find("#answers-container").find("input:text").on("keyup", function () {
            $("form").validate().element('#' + $(this).attr("id"));
        });




        $(".save-question").click(function (e) {

            e.preventDefault();

            let answerContainer = $(".question-container:not(:hidden)").find("#answers-container");

            let currentQuestion = answerContainer.closest("div.question-container").attr("id").split("-")[2];

            console.log(currentQuestion);

            $("form").validate().element(`input#Questions_${currentQuestion}__Title`);

            //PERFORM VALIDATION ON ANSWERS INPUT INDIVIDUALLY
            answerContainer.find("input").each(function () {
                console.log($(this));

                $("form").validate().element('#' + $(this).attr("id"));
            });



            

            answerContainer.find("input:checkbox").each(function () {

                $("form").validate().element('#' + $(this).attr("id"));
            });




            if (answerContainer.find("input.input-validation-error").length === 0 && !$(`input#Questions_${currentQuestion}__Title`).hasClass("input-validation-error")) {
                let questionNumber = parseInt(answerContainer.closest(".question-container").attr("id").split("-")[2]) + 1;
                if ($(`#question-button-${questionNumber - 1}`).length == 0) {
                    $(".questions-buttons-container").append(`<button id="question-button-${questionNumber - 1}" class="question-button" style="margin-right: 10px;">${questionNumber}</button>`);

                }

                answerContainer.closest(".question-container").hide();
                if (!answerContainer.closest(".question-container").hasClass("submitted")) {
                    answerContainer.closest(".question-container").addClass("submitted"); 
                }
                $(`#question-button-${questionNumber - 1}`).removeClass("bg-success");

            }
        });

        $(".questions-buttons-container").on("click", ".question-button", function (e) {
            e.preventDefault();
            let questionIndex = parseInt($(this).text()) - 1;

            $(".questions-buttons-container button").removeClass("bg-success");

            $(this).addClass("bg-success");

            $(".question-container").hide();
            $(`#question-container-${questionIndex}`).fadeIn();
            $(`#question-container-${questionIndex}`).find(".save-question").text("Редактиране на въпроса");
        })

    </script>

    <script>
        //$(".add-test").click(function (e) {
            //e.preventDefault();
            //$('.question-container:not(":first")').each(function () {
                //let questionIndex = parseInt($(this).attr("id").split("-")[2]);
                //localStorage.setItem(`Questions_html_${questionIndex}`, $(this).prop("outerHTML"));
                //localStorage.setItem(`Questions_${questionIndex}__Title`, $(this).find(`#Questions_${questionIndex}__Title`).val());
                //localStorage.setItem(`Questions_${questionIndex}__QuestionType`, $(this).find(`#Questions_${questionIndex}__QuestionType`).val());
                //localStorage.setItem(`Questions_${questionIndex}__Answers_FirstAnswerContent`, $(this).find(`#Questions_${questionIndex}__Answers_FirstAnswerContent`).val());
                //localStorage.setItem(`Questions_${questionIndex}__Answers_IsFirstAnswerCorrect`, $(this).find(`#Questions_${questionIndex}__Answers_IsFirstAnswerCorrect`).prop("checked"));
                //localStorage.setItem(`Questions_${questionIndex}__Answers_SecondAnswerContent`, $(this).find(`#Questions_${questionIndex}__Answers_SecondAnswerContent`).val());
                //localStorage.setItem(`Questions_${questionIndex}__Answers_IsSecondAnswerCorrect`, $(this).find(`#Questions_${questionIndex}__Answers_IsSecondAnswerCorrect`).prop("checked"));
                //localStorage.setItem(`Questions_${questionIndex}__Answers_ThirdAnswerContent`, $(this).find(`#Questions_${questionIndex}__Answers_ThirdAnswerContent`).val());
                //localStorage.setItem(`Questions_${questionIndex}__Answers_IsThirdAnswerCorrect`, $(this).find(`#Questions_${questionIndex}__Answers_IsThirdAnswerCorrect`).prop("checked"));
                //localStorage.setItem(`Questions_${questionIndex}__Answers_FourthAnswerContent`, $(this).find(`#Questions_${questionIndex}__Answers_FourthAnswerContent`).val());
                //localStorage.setItem(`Questions_${questionIndex}__Answers_IsFourthAnswerCorrect`, $(this).find(`#Questions_${questionIndex}__Answers_IsFourthAnswerCorrect`).prop("checked"));

            //});
            //$(".add-test").unbind("click");
            //$(".add-test").click();


        //});
    </script>
}
